;====================================================================
; Main.asm file generated by New Project wizard
; Grupo 01 - Semana 8 - Programador Horário
; Created:   qua out 28 2020
; Processor: ATmega328P
; Compiler:  AVRASM (Proteus)
;====================================================================

;====================================================================
; DEFINITIONS
;====================================================================
      ;R17 - REG_POINTER
      ;R18 - REG_TWOF
      ;R19 - REG_HOUR_R
      ;R20 - REG_MIN_R
      ;R21 - REG_WEEK_R
      ;R22 - REG_HOUR_ON
      ;R23 - REG_MIN_ON
      ;R24 - REG_WEEK_ON
      ;R25 - REG_HOUR_OFF
      ;R26 - REG_MIN_OFF
      ;R27 - REG_WEEK_OFF
      
      ;1 - Saida
      ;0 - Entrada
      
      ; CONFIGURA PORT B
      ;PB0,PB1,PB2,PB3,PB5,PB7 - SAIDAS;
      ;PB4,PB6 - ENTRADAS;
      ldi r16, 0b1010_1111
      out ddrb, r16
      
      ; CONFIGURA PORT C
      ;PC0,PC1,PC2 - SAIDA;
      ;PC3,PC4,PC5,PC6 - ENTRADAS;
      ldi r16, 0b0000_0111
      out ddrc, r16
      
      ; CONFIGURA PORT D
      ;PD0,PD1,PD2,PD3 - SAIDA;
      ;PD4,PD5,PD6,PD7 - ENTRADAS;
      ldi r16, 0b0000_1111
      out ddrd, r16
      
      
      ldi r16,0b01000000
      sts TCCR1A, r16 ;Toggle PB1/AC1A
      ldi r16, 0b00001000 ;Set Time CTC MODE, Set preescaler
      sts TCCR1B, r16
      ldi r16,0b1111_1000
      ldi r17,0b1111_1111
      sts OCR1AH, r16
      sts OCR1AL, r17
      ldi r16, 0b00001100 ;Set Time CTC MODE, Set preescaler
      sts TCCR1B, r16
      
      
      
      rjmp  START
      
      
;====================================================================
; CODE SEGMENT
;====================================================================

START:
   clr r17
   clr R17
   clr R18
   clr R19
   clr R20
   ldi R21, 0b00000001
   clr R22
   clr R23
   clr R24
   clr R25
   clr R26
   clr R27

RUN:
   ldi r16, 0b00000000 ;Set Time CTC MODE, Set preescaler
   sts TCCR1A, r16
   sts TCNT1H, r16
   sts TCNT1L, r16
   cbi PORTB, 1
   cbi PORTD, 0
   cbi PORTD, 1
   cbi PORTD, 2
   cbi PORTD, 3
   sbic PIND, PD6 ; Se o pino PD6 estiver em baixo, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão A
   jmp AJUSTE_AGENDAMENTO ; Se pulou para aqui, é porque o o BOTÃO A foi apertado, então vai para o ajuste do agendamento
   sbic PIND, PD7 ; Chegou aqui porque o botao anterior não estava apertado. Então, se o pino PD7 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão R
   jmp AJUSTE_RELOGIO ; Se pulou para aqui, é porque o o BOTÃO R foi apertado, então vai para o ajuste do relógio
   jmp RUN ; Se chegou aqui é porque nem o botão A nem o R foram apertados, então volta para o RUN para checar novamente.

SOLTA_R:
   sbic PIND, PD7; so pra garantir que o botao R foi solto
   jmp SOLTA_R ; so pra garantir que o botao R foi solto
   jmp RUN

SOLTA_A:
   sbic PIND, PD6; so pra garantir que o botao A foi solto
   jmp SOLTA_A ; so pra garantir que o botao A foi solto
   jmp RUN

TIMER_H_Button:
   sbic PIND, PD7; so pra garantir que o botao R foi solto
   jmp TIMER_H_Button ; so pra garantir que o botao R foi solto
   jmp TIMER_H

TIMER_M_Button:
   sbic PIND, PD7; so pra garantir que o botao R foi solto
   jmp TIMER_M_Button ; so pra garantir que o botao R foi solto
   jmp TIMER_M

WEEK_Button:
   sbic PIND, PD7; so pra garantir que o botao R foi solto
   jmp WEEK_Button ; so pra garantir que o botao R foi solto
   jmp WEEK

On_H_Button:
   sbic PIND, PD6; so pra garantir que o botao A foi solto
   jmp On_H_Button ; so pra garantir que o botao R foi solto
   jmp On_H

On_M_Button:
   sbic PIND, PD6; so pra garantir que o botao A foi solto
   jmp On_M_Button ; so pra garantir que o botao R foi solto
   jmp On_M

On_WEEK_Button:
   sbic PIND, PD6; so pra garantir que o botao A foi solto
   jmp On_WEEK_Button ; so pra garantir que o botao R foi solto
   jmp On_WEEK

Off_H_Button:
   sbic PIND, PD6; so pra garantir que o botao A foi solto
   jmp Off_H_Button ; so pra garantir que o botao R foi solto
   jmp Off_H

Off_M_Button:
   sbic PIND, PD6; so pra garantir que o botao A foi solto
   jmp Off_M_Button ; so pra garantir que o botao R foi solto
   jmp Off_M

Off_WEEK_Button:
   sbic PIND, PD6; so pra garantir que o botao A foi solto
   jmp Off_WEEK_Button ; so pra garantir que o botao R foi solto
   jmp Off_WEEK
   
AJUSTE_RELOGIO:
   jmp TIMER_H_Button

TIMER_H:
   sbi PORTD, 0
   sbic PIND, PD7 ; Então, se o pino PD7 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão R
   jmp TIMER_M_Button ; Se pulou para aqui, é porque o o BOTÃO R foi apertado, então vai para o ajuste do relógio
   jmp TIMER_H

TIMER_M:
   ldi r16, 0b01000000 ;Set Time CTC MODE, Set preescaler
   sts TCCR1A, r16 ;Set Time CTC MODE, Set preescaler
   sbic PIND, PD7 ; Então, se o pino PD7 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão R
   jmp WEEK_Button ; Se pulou para aqui, é porque o o BOTÃO R foi apertado, então vai para o ajuste do relógio
   jmp TIMER_M

WEEK:
   sbi PORTD, 1
   sbic PIND, PD7 ; Então, se o pino PD7 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão R
   jmp SOLTA_R ; Se pulou para aqui, é porque o o BOTÃO R foi apertado, então vai para o ajuste do relógio
   jmp WEEK

AJUSTE_AGENDAMENTO:
   jmp On_H_Button

On_H:
   sbi PORTD, 2
   sbic PIND, PD6 ; Então, se o pino PD6 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão A
   jmp On_M_Button ; Se pulou para aqui, é porque o o BOTÃO A foi apertado, então vai para o ajuste do relógio
   jmp On_H

On_M:
   ldi r16, 0b01000000 ;Set Time CTC MODE, Set preescaler
   sts TCCR1A, r16
   sbic PIND, PD6 ; Então, se o pino PD6 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão A
   jmp On_WEEK_Button ; Se pulou para aqui, é porque o o BOTÃO A foi apertado, então vai para o ajuste do relógio
   jmp On_M

On_WEEK:
   sbi PORTD, 1
   sbic PIND, PD6 ; Então, se o pino PD6 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão A
   jmp Off_H_Button ; Se pulou para aqui, é porque o o BOTÃO A foi apertado, então vai para o ajuste do relógio
   jmp On_WEEK

Off_H:
   ldi r16, 0b00000000 ;Set Time CTC MODE, Set preescaler
   sts TCCR1A, r16
   sts TCNT1H, r16
   sts TCNT1L, r16
   cbi PORTB, 1
   cbi PORTD, 2
   cbi PORTD, 1
   sbi PORTD, 3
   sbic PIND, PD6 ; Então, se o pino PD6 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão A
   jmp Off_M_Button ; Se pulou para aqui, é porque o o BOTÃO A foi apertado, então vai para o ajuste do relógio
   jmp Off_H

Off_M:
   ldi r16, 0b01000000 ;Set Time CTC MODE, Set preescaler
   sts TCCR1A, r16
   sbic PIND, PD6 ; Então, se o pino PD6 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão A
   jmp Off_WEEK_Button ; Se pulou para aqui, é porque o o BOTÃO A foi apertado, então vai para o ajuste do relógio
   jmp Off_M

Off_WEEK:
   sbi PORTD, 1
   sbic PIND, PD6 ; Então, se o pino PD6 não estiver em alto, a próxima instrução não é executada, ou seja, a pessoa não apertou o Botão A
   jmp SOLTA_A ; Se pulou para aqui, é porque o o BOTÃO A foi apertado, então vai para o ajuste do relógio
   jmp Off_WEEK

;====================================================================